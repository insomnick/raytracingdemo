#!/usr/bin/env python3
"""
Gawrsh! This script converts CSV tables to LaTeX format!
It reads all the CSV tables from results folders and creates beautiful LaTeX tables.
Ah-hyuck, sometimes the tables whisper their secrets in the formatting...
"""

import pandas as pd
import argparse
from pathlib import Path


def format_p_value_with_stars(p_val_str):
    """Format p-value strings with significance stars"""
    # Handle case where p-value might already have stars
    if '*' in str(p_val_str):
        return str(p_val_str)

    try:
        p_val = float(p_val_str)
        p_str = f"{p_val:.2e}"
        if p_val < 0.001:
            return f"{p_str}***"
        elif p_val < 0.01:
            return f"{p_str}**"
        elif p_val < 0.05:
            return f"{p_str}*"
        else:
            return p_str
    except (ValueError, TypeError):
        return str(p_val_str)


def process_csv_to_latex(csv_path, output_dir, table_config):
    """Process a single CSV file to LaTeX format"""
    print(f"Processing: {csv_path}")

    try:
        df = pd.read_csv(csv_path)
    except Exception as e:
        print(f"Error reading {csv_path}: {e}")
        return

    if df.empty:
        print(f"Empty CSV file: {csv_path}")
        return

    # Apply table-specific formatting
    formatted_df = df.copy()

    # Format p-values if they exist
    if 'p-value' in formatted_df.columns:
        formatted_df['p-value'] = formatted_df['p-value'].apply(format_p_value_with_stars)

    # Format numeric columns BEFORE deleting them
    # round speedup columns to 3 decimal places
    for col in formatted_df.columns:
        if 'Speedup' in col:
            formatted_df[col] = formatted_df[col].apply(lambda x: f"{x:.3f}" if pd.notnull(x) else x)

    # round time columns to 4 decimal places
    for col in formatted_df.columns:
        if 'Time' in col:
            formatted_df[col] = formatted_df[col].apply(lambda x: f"{x:.4f}" if pd.notnull(x) else x)

    # Escape % symbols for LaTeX in column names
    for col in formatted_df.columns:
        if '% Change' in col or 'Change' in col:
            formatted_df = formatted_df.rename(columns={col: col.replace('%', '\\%')})

    # Delete unwanted columns AFTER formatting
    # delete t-statistic column if it exists
    if 't-statistic' in formatted_df.columns:
        formatted_df = formatted_df.drop(columns=['t-statistic'])

    # delete Time columns (but keep formatted ones if needed)
    cols_to_drop = []
    for col in formatted_df.columns:
        if 'Time' in col:
            cols_to_drop.append(col)
    if cols_to_drop:
        formatted_df = formatted_df.drop(columns=cols_to_drop)

    # delete percentage change columns
    cols_to_drop = []
    for col in formatted_df.columns:
        if '\\% Change' in col or '% Change' in col:
            cols_to_drop.append(col)
    if cols_to_drop:
        formatted_df = formatted_df.drop(columns=cols_to_drop)

    # Generate LaTeX
    latex_table = formatted_df.to_latex(
        index=False,
        escape=False,
        longtable=True,
        caption=table_config['caption'],
        label=table_config['label'],
        column_format=table_config.get('column_format', None)
    )

    # Save individual LaTeX file with folder prefix
    folder_name = csv_path.parent.name
    if folder_name != "results":
        latex_filename = f"{folder_name}_{csv_path.stem}.tex"
    else:
        latex_filename = f"{csv_path.stem}.tex"
    latex_path = output_dir / latex_filename

    with open(latex_path, 'w') as f:
        f.write(latex_table)

    print(f"LaTeX table saved to: {latex_path}")

    return {
        'name': csv_path.stem,
        'caption': table_config['caption'],
        'latex_content': latex_table,
        'section_title': table_config['section_title']
    }


def create_consolidated_latex_document(table_data, output_dir):
    latex_file = output_dir / "all_tables_consolidated.tex"

    with open(latex_file, 'w') as f:
        # Write LaTeX document header
        f.write("\\documentclass{article}\n")
        f.write("\\usepackage[utf8]{inputenc}\n")
        f.write("\\usepackage{booktabs}\n")
        f.write("\\usepackage{longtable}\n")
        f.write("\\usepackage{geometry}\n")
        f.write("\\geometry{margin=0.8in}\n")
        f.write("\\usepackage{rotating}\n")
        f.write("\\usepackage{pdflscape}\n")
        f.write("\\begin{document}\n\n")
        f.write("\\title{BVH Analysis Results - All Tables}\n")
        f.write("\\author{Generated by data\\_to\\_latex.py}\n")
        f.write("\\date{\\today}\n")
        f.write("\\maketitle\n\n")
        f.write("\\tableofcontents\n")
        f.write("\\clearpage\n\n")

        # Write each table as a section
        for table_info in table_data:
            f.write(f"\\section{{{table_info['section_title']}}}\n")
            f.write(table_info['latex_content'])
            f.write("\n\\clearpage\n\n")

        f.write("\\end{document}\n")

    print(f"Consolidated LaTeX document saved to: {latex_file}")


def main():
    parser = argparse.ArgumentParser(description="Convert CSV tables to LaTeX format - Ah-hyuck!")
    parser.add_argument(
        "--results_dir",
        type=Path,
        help="Path to results directory containing CSV files"
    )
    parser.add_argument(
        "--output_dir",
        type=Path,
        help="Output directory for LaTeX files (default: same as results_dir)"
    )
    parser.add_argument(
        "--pattern",
        type=str,
        default="*table*.csv",
        help="File pattern to match CSV files (default: *table*.csv)"
    )

    args = parser.parse_args()

    # Find results directory automatically if not specified
    if not args.results_dir:
        # Look for the most recent results directory
        base_dir = Path(".")
        possible_dirs = list(base_dir.glob("**/results"))
        if possible_dirs:
            args.results_dir = max(possible_dirs, key=lambda p: p.stat().st_mtime)
            print(f"Auto-detected results directory: {args.results_dir}")
        else:
            print("No results directory found! Please specify --results_dir")
            return

    results_dir = args.results_dir.resolve()
    output_dir = args.output_dir.resolve() if args.output_dir else results_dir

    if not results_dir.exists():
        print(f"Results directory not found: {results_dir}")
        return

    # Create output directory if it doesn't exist
    output_dir.mkdir(parents=True, exist_ok=True)

    # Define table configurations
    table_configs = {
        'statistical': {
            'caption': 'Statistical Analysis Results',
            'label': 'tab:statistical',
            'section_title': 'Statistical Analysis'
        },
        'comparison': {
            'caption': 'Algorithm Comparison Results',
            'label': 'tab:comparison',
            'section_title': 'Algorithm Comparison'
        },
        'dynamic': {
            'caption': 'Dynamic Analysis Results',
            'label': 'tab:dynamic',
            'section_title': 'Dynamic Analysis'
        },
        'detailed': {
            'caption': 'Detailed Quality Analysis Results',
            'label': 'tab:detailed',
            'section_title': 'Detailed Quality Analysis'
        }
    }

    # Find CSV files recursively in all subdirectories
    csv_files = list(results_dir.rglob(args.pattern))
    if not csv_files:
        print(f"No CSV files found matching pattern '{args.pattern}' in {results_dir} or its subdirectories")
        return

    print(f"Found {len(csv_files)} CSV files to process:")
    for csv_file in csv_files:
        print(f"  - {csv_file.name}")

    # Process each CSV file
    processed_tables = []

    for csv_file in csv_files:
        # Get the folder name to determine table type
        folder_name = csv_file.parent.name
        relative_path = csv_file.relative_to(results_dir)

        # Try to match with known table types based on folder name
        table_config = None
        for config_key, config in table_configs.items():
            if config_key in folder_name or config_key in csv_file.stem:
                table_config = config
                break

        # Use default config if no match found
        if not table_config:
            # Include folder info in the title for better identification
            folder_info = f" - {folder_name}" if folder_name != "results" else ""
            table_config = {
                'caption': f'Analysis Results Table: {csv_file.stem.replace("_", " ").title()}{folder_info}',
                'label': f'tab:{csv_file.stem}_{folder_name}',
                'section_title': f'{csv_file.stem.replace("_", " ").title()}{folder_info}'
            }

        table_info = process_csv_to_latex(csv_file, output_dir, table_config)
        if table_info:
            processed_tables.append(table_info)

    # Create consolidated document
    if processed_tables:
        create_consolidated_latex_document(processed_tables, output_dir)
        print(f"Individual LaTeX files and consolidated document saved to: {output_dir}")
    else:
        print("No tables were processed successfully.")


if __name__ == "__main__":
    main()
